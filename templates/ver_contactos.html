{% extends 'base.html' %}

{% block title %}{{ _('Ver Contactos') }}{% endblock %}

{% block head_content %}
<style>
    /* Estilos para la página de contactos (ejemplo) */
    .fab-button {
        position: fixed;
        bottom: 70px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    
    /* Estilos para la vista de cuadrícula (grid) */
    .contact-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }
    .contact-card {
        border: 1px solid var(--bs-border-color);
        border-radius: 12px;
        background-color: var(--bs-tertiary-bg);
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .contact-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .contact-card img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 1rem;
        border: 3px solid var(--bs-warning);
    }
    .contact-card h5 {
        font-weight: 600;
        color: var(--bs-body-color);
        margin-bottom: 0.25rem;
    }
    .contact-card .username {
        color: var(--bs-secondary);
        font-size: 0.9em;
        margin-bottom: 1rem;
    }
    .contact-card .actions {
        margin-top: 1rem;
        display: flex;
        justify-content: center;
        gap: 0.5rem;
    }
    .view-toggle {
        font-size: 1.5rem;
        color: var(--bs-secondary);
    }
    .view-toggle.active {
        color: var(--bs-warning);
    }
</style>
{% endblock %}


{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h1 class="mb-0">{{ _('Administración de Contactos') }}</h1>
        <span class="badge bg-secondary fs-6">{{ _('%(count)s Usuarios', count=user_count) }}</span>
    </div>
    
    <!-- Formulario de Búsqueda y Toggle de Vista -->
    <form method="GET" action="{{ url_for('contactos.ver_contactos') }}" class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="input-group" style="flex-grow: 1; margin-right: 1rem;">
                <input type="text" class="form-control" name="search_query" placeholder="{{ _('Buscar por nombre, usuario, email...') }}" value="{{ search_query or '' }}">
                <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-search"></i></button>
            </div>
            
            <!-- Hidden input to maintain view mode on search -->
            <input type="hidden" name="view" value="{{ view_mode }}">
            
            <!-- Toggle de Vista -->
            <div>
                <a href="{{ url_for('contactos.ver_contactos', view='list', search_query=search_query) }}" class="view-toggle me-2 {% if view_mode == 'list' %}active{% endif %}" title="{{ _('Vista de Lista') }}">
                    <i class="fas fa-list"></i>
                </a>
                <a href="{{ url_for('contactos.ver_contactos', view='grid', search_query=search_query) }}" class="view-toggle {% if view_mode == 'grid' %}active{% endif %}" title="{{ _('Vista de Cuadrícula') }}">
                    <i class="fas fa-th-large"></i>
                </a>
            </div>
        </div>
    </form>

    {% if not users %}
        <div class="alert alert-info text-center">{{ _('No se encontraron contactos que coincidan con tu búsqueda.') }}</div>
    {% else %}
        
        <!-- VISTA DE LISTA (TABLA) -->
        {% if view_mode == 'list' %}
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>{{ _('Avatar') }}</th>
                        <th>{{ _('Usuario') }}</th>
                        <th>{{ _('Nombre Completo') }}</th>
                        <th>{{ _('Email') }}</th>
                        <th>{{ _('Teléfono') }}</th>
                        <th>{{ _('Rol') }}</th>
                        <th>{{ _('Acciones') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contacto in users %} 
                    <tr>
                        <td>
                            <img src="{{ url_for('static', filename=contacto.avatar_url or 'uploads/avatars/default.png') }}" alt="Avatar" class="img-fluid rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                        </td>
                        <td>{{ contacto.username }}</td>
                        <td>{{ contacto.nombre }} {{ contacto.primer_apellido }}</td>
                        <td>{{ contacto.email or 'N/A' }}</td>
                        <td>{{ contacto.telefono }}</td>
                        <td>
                            <span class="badge {% if contacto.role == 'Superuser' %}bg-danger{% elif contacto.role == 'Administrador' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                {{ contacto.role }}
                            </span>
                        </td>
                        <td>
                            <!-- Botones de acción (ejemplo) -->
                            <a href="{{ url_for('contactos.ver_detalle', user_id=contacto.id) }}" class="btn btn-sm btn-info" title="{{ _('Ver') }}"><i class="fas fa-eye"></i></a>
                            
                            <!-- Solo Superuser, Admin, o el propio usuario pueden editar -->
                            {% if current_role in ['Superuser', 'Administrador'] or session.user_id == contacto.id %}
                                <a href="{{ url_for('contactos.editar_contacto', user_id=contacto.id) }}" class="btn btn-sm btn-primary" title="{{ _('Editar') }}"><i class="fas fa-edit"></i></a>
                            {% endif %}
                            
                            <!-- Lógica para el botón de eliminar -->
                            {% if current_role == 'Superuser' and session.user_id != contacto.id %}
                            <form action="{{ url_for('contactos.eliminar_contacto', user_id=contacto.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('{{ _('¿Estás seguro de que quieres eliminar a este usuario?') }}');">
                                <button type="submit" class="btn btn-sm btn-danger" title="{{ _('Eliminar') }}"><i class="fas fa-trash"></i></button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- VISTA DE CUADRÍCULA (GRID) -->
        {% elif view_mode == 'grid' %}
        <div class="contact-grid">
            {% for contacto in users %}
            <div class="contact-card">
                <img src="{{ url_for('static', filename=contacto.avatar_url or 'uploads/avatars/default.png') }}" alt="Avatar">
                <h5>{{ contacto.nombre }} {{ contacto.primer_apellido }}</h5>
                <div class="username">@{{ contacto.username }}</div>
                <p class="mb-0">{{ contacto.email or 'N/A' }}</p>
                <p>{{ contacto.telefono }}</p>
                <span class="badge {% if contacto.role == 'Superuser' %}bg-danger{% elif contacto.role == 'Administrador' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                    {{ contacto.role }}
                </span>
                
                <div class="actions">
                    <a href="{{ url_for('contactos.ver_detalle', user_id=contacto.id) }}" class="btn btn-sm btn-info" title="{{ _('Ver') }}"><i class="fas fa-eye"></i></a>
                    
                    {% if current_role in ['Superuser', 'Administrador'] or session.user_id == contacto.id %}
                        <a href="{{ url_for('contactos.editar_contacto', user_id=contacto.id) }}" class="btn btn-sm btn-primary" title="{{ _('Editar') }}"><i class="fas fa-edit"></i></a>
                    {% endif %}
                    
                    {% if current_role == 'Superuser' and session.user_id != contacto.id %}
                    <form action="{{ url_for('contactos.eliminar_contacto', user_id=contacto.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('{{ _('¿Estás seguro de que quieres eliminar a este usuario?') }}');">
                        <button type="submit" class="btn btn-sm btn-danger" title="{{ _('Eliminar') }}"><i class="fas fa-trash"></i></button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
    {% endif %}

    <!-- Botón Flotante para Agregar -->
    <!-- 
      --- CORRECCIÓN (Línea 300 del traceback) ---
      El url_for apuntaba a 'register', ahora apunta a 'auth.register'
    -->
    <a href="{{ url_for('auth.register') }}" class="btn btn-warning fab-button" title="{{ _('Agregar nuevo contacto') }}">
        <i class="fas fa-plus"></i>
    </a>

</div>
{% endblock %}

